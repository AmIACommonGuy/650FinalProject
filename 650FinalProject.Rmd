---
title: "GroupProject"
author: "LAUREN"
date: "11/23/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
nh = data.frame(NHANES::NHANES)
library("Hmisc")
library("dplyr")
library("tidyr")
library("sas7bdat")
library("corrplot")
library("gtsummary")
library("dplyr")
```


```{r}
varinterst = c("Age","Gender","Race1","PhysActive","Depressed","Diabetes","BPSysAve", "BPDiaAve", "TotChol", "Testosterone", "RegularMarij", "BMI", "Weight", "Height")

nh1 = nh[,varinterst]
nh1 <- nh1[ which(nh1$Age >=18 & nh1$Age <=59), ]

nh1 <- nh1 %>%
  mutate(HypT = if_else(nh1$BPSysAve >= 130 | nh1$BPDiaAve >=80, 1, 0)) #Add hypertension variable
nh1 <- nh1 %>%
  mutate(Sex = ifelse(nh1$Gender == "female", 1, 0)) 
nh1 <- nh1 %>%
  mutate(PhysAc = ifelse(nh1$PhysActive == "No", 0, 1)) 
nh1 <- nh1 %>%
  mutate(Diabete = ifelse(nh1$Diabetes == "No", 0, 1))
nh1 <- nh1 %>%
  mutate(Depress = ifelse(nh1$Depressed == "None", 0, 1))
nh1 <- nh1 %>%
  mutate(RegularMarij2 = ifelse(nh1$RegularMarij == "No", 0, 1))
nh1$TotChol = log(nh1$TotChol)
nh1$Incomplete = complete.cases(nh1)
nh1$Race1 = as.factor(nh1$Race1)
nh1$Weight = nh1$Weight-mean(nh1$Weight, na.rm = TRUE)
nh1$Height = nh1$Height-mean(nh1$Height, na.rm = TRUE)

drops = c("Sex")
nhF= nh1[ which(nh1$Sex == 1), ]
nhM = nh1[ which(nh1$Sex == 0), ]
nhF = nhF[,!(names(nhF) %in% drops)]
nhM = nhM[,!(names(nhM) %in% drops)]
```


```{r}
## Shiny app
nhF %>%
 tbl_summary(by = Incomplete,
              missing = "no",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              ) %>%
  add_n %>%
  add_p(test = list(Age ~ "t.test",
                    Race1 ~ "chisq.test",
                    PhysAc ~ "chisq.test",
                    Depress ~ "chisq.test",
                    Diabete ~ "chisq.test",
                    BPSysAve ~ "t.test",
                    TotChol ~ "t.test",
                    Testosterone ~ "t.test",
                    RegularMarij2 ~ "chisq.test"),
        test.args = all_tests("t.test") ~ list(var.equal = TRUE), ## Important argument! 
        pvalue_fun = function(x) style_pvalue(x, digits = 2)) %>%
  bold_p(t = 0.05) %>%
  bold_labels
```


```{r}
nhM %>%
 tbl_summary(by = Incomplete,
              missing = "no",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              ) %>%
  add_n %>%
  add_p(test = list(Age ~ "t.test",
                    Race1 ~ "chisq.test",
                    PhysAc ~ "chisq.test",
                    Depress ~ "chisq.test",
                    Diabete ~ "chisq.test",
                    HypT ~ "chisq.test",
                    TotChol ~ "t.test",
                    Testosterone ~ "t.test",
                    RegularMarij2 ~ "chisq.test"),
        test.args = all_tests("t.test") ~ list(var.equal = TRUE),## Important argument! 
        pvalue_fun = function(x) style_pvalue(x, digits = 2)) %>%
  bold_p(t = 0.05) %>%
  bold_labels
```

```{r}
nh1 %>%
 tbl_summary(by = Incomplete,
              missing = "no",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              ) %>%
  add_n %>%
  add_p(test = list(Age ~ "t.test",
                    Race1 ~ "chisq.test",
                    PhysAc ~ "chisq.test",
                    Depress ~ "chisq.test",
                    Diabete ~ "chisq.test",
                    HypT ~ "chisq.test",
                    TotChol ~ "t.test",
                    Testosterone ~ "t.test",
                    RegularMarij2 ~ "chisq.test"),
        test.args = all_tests("t.test") ~ list(var.equal = TRUE),## Important argument! 
        pvalue_fun = function(x) style_pvalue(x, digits = 2)) %>%
  bold_p(t = 0.05) %>%
  bold_labels
```

Our first limitation is that complete/incomplete data are significantly different. Even if we adjusted for gender, there is still significant difference between the two data set. Using the complete model can be biased


```{r}
## Complete case model nh2
nh2 <- nh1 %>% drop_na() #drop anything with NA
## Full model with age as continuous variable
m1 =  lm(log(Testosterone)~
             Age + Sex + Race1 + PhysAc + Depress + Weight + 
             Diabete + BPSysAve + TotChol + RegularMarij2 + Height, 
         data = nh2)
summary(m1)
```


```{r}
## quantile(nh2$Age, probs = seq(0, 1, 0.25))
## Change Age into categorical variable
AgeQ1 <- nh2$Age<28
AgeQ2 <- nh2$Age>=28 & nh2$Age<39
AgeQ3 <- nh2$Age>=39 & nh2$Age<49
AgeQ4 <- nh2$Age>=49 & nh2$Age<59

m_ageC <- lm(log(Testosterone)~
                 AgeQ2 + AgeQ3 + AgeQ4 + 
                 Sex + Race1 + PhysAc + Depress + Weight + Height +
                 Diabete + BPSysAve + TotChol + RegularMarij2, 
             data = nh2)
summary(m_ageC)
```

According to the plot we found out that age, weight, height, and BPSysAve are linear. We can use age as a non-categorical value because it gives us higher r^2
```{r}
car::avPlots(m_ageC)
```



```{r}
## Check age linearity
plot(1:3, m_ageC$coefficients[2:4])
```

```{r}
## full model with interaction : Final model
m_age_it <- lm(log(Testosterone) ~ 
                    Age + 
                    Sex + Race1 + PhysAc + Depress + Diabete + 
                    BPSysAve+ TotChol + RegularMarij2 +  Weight + Height +
                    RegularMarij2*(Age + Sex +  Weight + Height +
                                   Race1 + PhysAc + Depress + 
                                   Diabete + BPSysAve+ TotChol), 
                data = nh2)
summary(m_age_it)
```

```{r}
## full model with interaction : Final model
m_age_it <- lm(log(Testosterone) ~ 
                    Age + 
                    Sex + Race1 + PhysAc + Diabete + 
                    BPSysAve + RegularMarij2 +  Weight + Height +
                    RegularMarij2*(Age +  Weight + Height +
                                   Race1 + PhysAc + 
                                   Diabete + BPSysAve), 
                data = nh2)
summary(m_age_it)
```



```{r}
## Check co-linearity
cor(nh2[c("Diabete", "TotChol", "HypT", "PhysAc","Depress", "Weight", "Height")])
```
## linearity check
```{r}
car::avPlots(m_age_it)
```
```{r}
## For independence, we check literature. 
```

This is our final model, but we need to further select significant terms.



```{r}
## model without iteraction

m_age_woit <- lm(log(Testosterone) ~ 
                   
                    Age + 
                    Sex + Race1 + PhysAc + Depress + Diabete + 
                    BPSysAve+ TotChol + RegularMarij2 +  Weight + Height, 
                data = nh2)
summary(m_age_woit)
```