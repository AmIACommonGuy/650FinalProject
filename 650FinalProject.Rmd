---
title: "GroupProject"
author: "LAUREN", "Ziming"
date: "11/23/2021"
output: pdf_document
---
## Loading Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
nh = data.frame(NHANES::NHANES)
library("Hmisc")
library("dplyr")
library("tidyr")
library("sas7bdat")
library("corrplot")
library("gtsummary")
library("dplyr")
library("olsrr")
```

## Data Cleaning and Variates Selection
```{r}
varinterst = c("Age","Gender","Race1","PhysActive","Depressed","Diabetes","BPSysAve", "BPDiaAve", "TotChol", "Testosterone", "RegularMarij", "Weight", "Height")

nh1 = nh[,varinterst]
nh1 <- nh1[ which(nh1$Age >=18 & nh1$Age <=59), ] #Due to Marijuana variable. 

nh1 <- nh1 %>%
  mutate(HypT = if_else(nh1$BPSysAve >= 130 | nh1$BPDiaAve >=80, 1, 0)) #Add hypertension variable
nh1 <- nh1 %>%
  mutate(Sex = ifelse(nh1$Gender == "female", 1, 0)) #Recode Sex into binary where female=1, male=0
nh1 <- nh1 %>%
  mutate(PhysAc = ifelse(nh1$PhysActive == "No", 0, 1)) #Recode Activity into binary where No=0, Yes=1
nh1 <- nh1 %>%
  mutate(Diabete = ifelse(nh1$Diabetes == "No", 0, 1)) #Recode Diabetes into binary where No=0, Yes=1
nh1 <- nh1 %>%
  mutate(Depress = ifelse(nh1$Depressed == "None", 0, 1))  #Recode Depressed into binary where No report=0, Reported Depression=1
nh1 <- nh1 %>%
  mutate(RegularMarij2 = ifelse(nh1$RegularMarij == "No", 0, 1)) #Recode Regular Marij into binary where No=0, Yes=1

nh1$Incomplete = complete.cases(nh1) 
nh1$Race1 = as.factor(nh1$Race1) #Race as factor
#Creates Sex Specific Data Sets
drops = c("Sex")
nhF= nh1[ which(nh1$Sex == 1), ]
nhM = nh1[ which(nh1$Sex == 0), ]
nhF = nhF[,!(names(nhF) %in% drops)]
nhM = nhM[,!(names(nhM) %in% drops)]
```

## Complete/Incomplete Data Set
```{r}
nh1 %>%
 tbl_summary(by = Incomplete,
              missing = "no",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              ) %>%
  add_n %>%
  add_p(test = list(Age ~ "t.test",
                    Race1 ~ "chisq.test",
                    PhysAc ~ "chisq.test",
                    Depress ~ "chisq.test",
                    Diabete ~ "chisq.test",
                    HypT ~ "chisq.test",
                    TotChol ~ "t.test",
                    Testosterone ~ "t.test",
                    RegularMarij2 ~ "chisq.test"),
        test.args = all_tests("t.test") ~ list(var.equal = TRUE),## Important argument! 
        pvalue_fun = function(x) style_pvalue(x, digits = 2)) %>%
  bold_p(t = 0.05) %>%
  bold_labels
```
## Female only Complete/Incomplete Data Set
```{r}
## Shiny app
nhF %>%
 tbl_summary(by = Incomplete,
              missing = "no",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              ) %>%
  add_n %>%
  add_p(test = list(Age ~ "t.test",
                    Race1 ~ "chisq.test",
                    PhysAc ~ "chisq.test",
                    Depress ~ "chisq.test",
                    Diabete ~ "chisq.test",
                    BPSysAve ~ "t.test",
                    TotChol ~ "t.test",
                    Testosterone ~ "t.test",
                    RegularMarij2 ~ "chisq.test"),
        test.args = all_tests("t.test") ~ list(var.equal = TRUE), ## Important argument! 
        pvalue_fun = function(x) style_pvalue(x, digits = 2)) %>%
  bold_p(t = 0.05) %>%
  bold_labels
```

##Exploratory Stats: Male only Complete/Incomplete Data Set
```{r}
nhM %>%
 tbl_summary(by = Incomplete,
              missing = "no",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              ) %>%
  add_n %>%
  add_p(test = list(Age ~ "t.test",
                    Race1 ~ "chisq.test",
                    PhysAc ~ "chisq.test",
                    Depress ~ "chisq.test",
                    Diabete ~ "chisq.test",
                    HypT ~ "chisq.test",
                    TotChol ~ "t.test",
                    Testosterone ~ "t.test",
                    RegularMarij2 ~ "chisq.test"),
        test.args = all_tests("t.test") ~ list(var.equal = TRUE),## Important argument! 
        pvalue_fun = function(x) style_pvalue(x, digits = 2)) %>%
  bold_p(t = 0.05) %>%
  bold_labels
```
Our first limitation is that complete/incomplete data are significantly different. Even if we adjusted for gender, there is still significant difference between the two data set. Using the complete model can be biased
```{r}
nh2 = drop_na(nh1) #complete data set
```

## Exploratory Stats: Testosterone/Categorical Variables Tables (assess)
```{r}
SummaryTestTable <- function(x){ 
nh3 = nh2[,c(all_of(x),"Testosterone", "Age", "TotChol", "Weight", "Height")]
  nh3 %>%
   tbl_summary(by = all_of(x),
                missing = "no",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              ) %>%
  add_n %>%
  add_p(test = list(Testosterone ~ "t.test",
                    Age ~ "t.test",
                    TotChol ~ "t.test",
                    Weight ~ "t.test",
                    Height ~ "t.test"),
        test.args = all_tests("t.test") ~ list(var.equal = TRUE),## Important argument! 
        pvalue_fun = function(x) style_pvalue(x, digits = 2)) %>%
  bold_p(t = 0.05) %>%
  bold_labels}

for (i in c("Gender","PhysAc","Depress","Diabetes",  "HypT", "RegularMarij")) {
  print(SummaryTestTable(i))
}

nh3 = nh2[,c("Race1","Testosterone", "Age", "TotChol", "Weight", "Height")]
  nh3 %>%
   tbl_summary(by = Race1,
                missing = "no",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              ) %>%
  add_n %>%
 add_p(test = list(Testosterone ~ "aov",
                    Age ~ "aov",
                    TotChol ~ "aov",
                    Weight ~ "aov",
                    Height ~ "aov"),
        test.args = all_tests("aov") ~ list(var.equal = TRUE),## Important argument! 
        pvalue_fun = function(x) style_pvalue(x, digits = 2)) %>%
  bold_p(t = 0.05) %>%
  bold_labels

```
## Exploratory Stats: Continous Variables
```{r}
#Compare Y to continous X
scatmatrixData = nh2[,c("Testosterone", "TotChol", "Age", "Height", "Weight")]
panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}
pairs(scatmatrixData, pch = 19, diag.panel=panel.hist)
cormat = cor(scatmatrixData)
pres <- cor.mtest(scatmatrixData, conf.level = .95)
corrplot.mixed(cormat, lower.col = "black", number.cex = 1,p.mat = pres$p, sig.level = .05)
```
## Now center continous variables (Needed)
```{r}
nh2$Weight = (nh2$Weight-mean(nh2$Weight, na.rm = TRUE))/sd(nh2$Weight, na.rm = TRUE)
nh2$Height = (nh2$Height-mean(nh2$Height, na.rm = TRUE))/sd(nh2$Height, na.rm = TRUE)
nh2$Agec = (nh2$Age-mean(nh2$Age, na.rm = TRUE))/sd(nh2$Age, na.rm = TRUE)
nh2$TotChol = (nh2$TotChol-mean(nh2$TotChol, na.rm = TRUE))/sd(nh2$TotChol, na.rm = TRUE)
```
## Function to check assumptions
```{r}
checka <- function (model) {
  car::avPlots(model)
  plot(model$fitted.values, model$residuals)
  hist(model$residuals)
  qqnorm(model$residuals)
  shapiro.test(model$residuals)
}
``` 
## Unrefined Model (what to say about this?)
```{r}
m_unrefined <- lm(Testosterone~RegularMarij2, data=nh2)
summary(m_unrefined)
checka(m_unrefined)
```
## Adjusted Model with no log (to provide justifaction for log(T))
```{r}
m_adjusted_nolog =  lm(Testosterone~RegularMarij2 + Agec + Sex + Race1 + PhysAc + Depress + Weight + 
             Diabete + HypT + TotChol + Height, 
         data = nh2)
summary(m_adjusted_nolog)
checka(m_adjusted_nolog)
```
## Adjusted Model log(Y)
```{r}
m1 <- lm(log(Testosterone)~RegularMarij2 + Agec + Sex + Race1 + PhysAc + Depress + Weight +  Diabete + HypT + TotChol + Height, data = nh2)
summary(m1)
checka(m1)
```



```{r}
## Do not need to do this if partial regression with agec continous shows linear
m_ageC <- lm(log(Testosterone)~
                 AgeQ2 + AgeQ3 + AgeQ4 + 
                 Sex + Race1 + PhysAc + Depress + Weight + Height +
                 Diabete + HypT + TotChol + RegularMarij2, 
             data = nh2)
summary(m_ageC)
## Check age linearity
plot(1:3, m_ageC$coefficients[2:4])
## Check quadriatic
Agec <- (nh2$Age-mean(nh2$Age))/sd(nh2$Age)
m_age_it_2 <- lm(log(Testosterone) ~ 
                    I(Agec) + I(Agec^2)+
                    Sex + Race1 + PhysAc + Depress + Diabete + 
                    HypT+ TotChol + RegularMarij2 +  Weight + Height, 
                data = nh2)
summary(m_age_it_2)
```


## The following code tests to see if Beta for race are equal. Find that all 5 are not and B for Race1"Black" is diff. We do not need to do this, so we can remove it. reduces our R^2 but simplies intreptation. 
```{r}
# Model with Race as well coding, want to see if can combine race categories
m_wo_its =  lm(log(Testosterone)~ -1 + RegularMarij2 + Agec + Sex + Race1 + PhysAc + Depress + Weight + 
             Diabete + HypT + TotChol + Height, 
         data = nh2)
summary(m_wo_its)
```

```{r}
#Test to see (4) racial categories can be combined into one
Contrast.T = matrix(c(0,0,1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0,0,0,0,0,0),byrow = T, nrow = 4) 

car::linearHypothesis(model=m_wo_its,hypothesis.matrix=Contrast.T, rsh=c(0,0,0,0))

#Test to see if (3) can be combined into one
Contrast.T = matrix(c(0,0,0,1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0,0,0,0,0,0),byrow = T, nrow = 3)

car::linearHypothesis(model=m_wo_its,hypothesis.matrix=Contrast.T, rsh=c(0,0,0))
```

```{r}
#Recode race into black and non-black
nh2 <- nh2 %>%
  mutate(Race2 = ifelse(nh2$Race1 == "Black", 0, 1))
#model with intercept and race as binary
m1.2 =  lm(log(Testosterone)~RegularMarij2 + Agec + Sex + Race2 + PhysAc + Depress + Weight + 
             Diabete + HypT + TotChol + Height, data = nh2)
summary(m1.2)
checka(m1.2)
```

## If we decide to use above code, this is the final model without interaction. 
```{r}
## model without interaction
m_age_woit <- lm(log(Testosterone)~RegularMarij2 + Agec + Sex + Race2 + PhysAc + Depress + Weight + 
             Diabete + HypT + TotChol + Height, data = nh2)
summary(m_age_woit)
checka(m_age_woit)
```

## This would be our final model. 
```{r}
## full model with interaction : Final model based on journal reading and exploratory analysis 
m_age_it <- lm(log(Testosterone)~RegularMarij2 + Agec + Sex + Race2 + PhysAc + Depress + Weight + 
             Diabete + HypT + TotChol + Height + HypT*Weight + Weight*Height + Agec*(Weight + Height) +
                    Diabete*(Weight + PhysAc + TotChol) + RegularMarij2*PhysAc,data = nh2)
summary(m_age_it)
checka(m_age_it)
```




```{r}
## Check co-linearity
cor(nh2[c("Age","Diabete", "TotChol", "HypT", "PhysAc","Depress", "Weight", "Height")])
## Add VIF later
```

```{r}
## if we want to do backwards selection
olsrr::ols_step_backward_p(m_age_it, prem = 0.25, details=F)
```

```{r}
## Final model
m_age_it <- lm(log(Testosterone) ~ 
                    Agec + 
                    Sex + Race2 + Diabete + 
                    HypT + RegularMarij2 +  Weight + Height + 
                    Weight*Height + Agec*(Weight + Height) +
                    Diabete*PhysAc + RegularMarij2*PhysAc
               ,
                data = nh2)
summary(m_age_it)
```

##Adjusted Model with considering first literature, then explatory stat, sand log (Y) AND interaction adjusted model only adding interactions for B that are signifcant in non-interaction and exploratory stats/lit supports
```{r}
m_alt =  lm(log(Testosterone)~RegularMarij2 + Agec + Sex  + Depress + Weight + HypT + TotChol + Height, 
         data = nh2)
summary(m_alt)
checka(m_alt)

m_alt_int =  lm(log(Testosterone)~RegularMarij2 + Agec + Sex  + Depress + Weight + HypT + TotChol + Height + Weight*Height + Agec*(Weight + Height) + Sex*(Weight + Height), 
         data = nh2)
summary(m_alt_int)
checka(m_alt_int)

hats = hatvalues(m_alt)
hats[ which(hats>0.5)]
hats[ which(hats>0.2)]
hats[which(hats>2*mean(hats))]
olsrr::ols_plot_dffits(m_alt)
olsrr::ols_plot_dfbetas(m_alt)
olsrr::ols_plot_cooksd_chart(m_alt)
m_alt_cov = covratio(m_alt)
n = nrow(nh2) 
p = m_alt$rank
which( (abs(m_alt_cov-1)) > 3*p/n )
plot(m_alt_cov); abline(1+3*p/n,0); abline(1-3*p/n,0)

```







