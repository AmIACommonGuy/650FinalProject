---
title: "GroupProject"
author: "LAUREN", "Ziming"
date: "11/23/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
nh = data.frame(NHANES::NHANES)
library("Hmisc")
library("dplyr")
library("tidyr")
library("sas7bdat")
library("corrplot")
library("gtsummary")
library("dplyr")
library("olsrr")
```

## Data Cleaning and Variates Selection
```{r}
varinterst = c("Age","Gender","Race1","PhysActive","Depressed","Diabetes","BPSysAve", "BPDiaAve", "TotChol", "Testosterone", "RegularMarij", "Weight", "Height")

nh1 = nh[,varinterst]
nh1 <- nh1[ which(nh1$Age >=18 & nh1$Age <=59), ]

nh1 <- nh1 %>%
  mutate(HypT = if_else(nh1$BPSysAve >= 130 | nh1$BPDiaAve >=80, 1, 0)) #Add hypertension variable
nh1 <- nh1 %>%
  mutate(Sex = ifelse(nh1$Gender == "female", 1, 0)) 
nh1 <- nh1 %>%
  mutate(PhysAc = ifelse(nh1$PhysActive == "No", 0, 1)) 
nh1 <- nh1 %>%
  mutate(Diabete = ifelse(nh1$Diabetes == "No", 0, 1))
nh1 <- nh1 %>%
  mutate(Depress = ifelse(nh1$Depressed == "None", 0, 1))
nh1 <- nh1 %>%
  mutate(RegularMarij2 = ifelse(nh1$RegularMarij == "No", 0, 1))
nh1$TotChol = log(nh1$TotChol)
nh1$Incomplete = complete.cases(nh1)
nh1$Race1 = as.factor(nh1$Race1)

## Centering weight
nh1$Weight = (nh1$Weight-mean(nh1$Weight, na.rm = TRUE))/sd(nh1$Weight, na.rm = TRUE)
nh1$Height = (nh1$Height-mean(nh1$Height, na.rm = TRUE))/sd(nh1$Height, na.rm = TRUE)


drops = c("Sex")
nhF= nh1[ which(nh1$Sex == 1), ]
nhM = nh1[ which(nh1$Sex == 0), ]
nhF = nhF[,!(names(nhF) %in% drops)]
nhM = nhM[,!(names(nhM) %in% drops)]
```

## Complete/Incomplete Data Set
```{r}
nh1 %>%
 tbl_summary(by = Incomplete,
              missing = "no",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              ) %>%
  add_n %>%
  add_p(test = list(Age ~ "t.test",
                    Race1 ~ "chisq.test",
                    PhysAc ~ "chisq.test",
                    Depress ~ "chisq.test",
                    Diabete ~ "chisq.test",
                    HypT ~ "chisq.test",
                    TotChol ~ "t.test",
                    Testosterone ~ "t.test",
                    RegularMarij2 ~ "chisq.test"),
        test.args = all_tests("t.test") ~ list(var.equal = TRUE),## Important argument! 
        pvalue_fun = function(x) style_pvalue(x, digits = 2)) %>%
  bold_p(t = 0.05) %>%
  bold_labels
```

```{r}
## Shiny app
nhF %>%
 tbl_summary(by = Incomplete,
              missing = "no",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              ) %>%
  add_n %>%
  add_p(test = list(Age ~ "t.test",
                    Race1 ~ "chisq.test",
                    PhysAc ~ "chisq.test",
                    Depress ~ "chisq.test",
                    Diabete ~ "chisq.test",
                    BPSysAve ~ "t.test",
                    TotChol ~ "t.test",
                    Testosterone ~ "t.test",
                    RegularMarij2 ~ "chisq.test"),
        test.args = all_tests("t.test") ~ list(var.equal = TRUE), ## Important argument! 
        pvalue_fun = function(x) style_pvalue(x, digits = 2)) %>%
  bold_p(t = 0.05) %>%
  bold_labels
```


```{r}
nhM %>%
 tbl_summary(by = Incomplete,
              missing = "no",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{n} ({p}%)"),
              ) %>%
  add_n %>%
  add_p(test = list(Age ~ "t.test",
                    Race1 ~ "chisq.test",
                    PhysAc ~ "chisq.test",
                    Depress ~ "chisq.test",
                    Diabete ~ "chisq.test",
                    HypT ~ "chisq.test",
                    TotChol ~ "t.test",
                    Testosterone ~ "t.test",
                    RegularMarij2 ~ "chisq.test"),
        test.args = all_tests("t.test") ~ list(var.equal = TRUE),## Important argument! 
        pvalue_fun = function(x) style_pvalue(x, digits = 2)) %>%
  bold_p(t = 0.05) %>%
  bold_labels
```



Our first limitation is that complete/incomplete data are significantly different. Even if we adjusted for gender, there is still significant difference between the two data set. Using the complete model can be biased

```{r}
table1(~Testosterone | RegularMarij, data=nh2)
table1(~Testosterone | Gender, data=nh2)
table1(~Testosterone | Race1, data=nh2)
table1(~Testosterone | Diabetes, data=nh2)
table1(~Testosterone | PhysActive, data=nh2)
table1(~Testosterone | HypT, data=nh2)
#Compare Y to continous X
scatmatrixData = nh2[,c("Testosterone", "TotChol", "Age", "Height", "Weight")]
panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}
pairs(scatmatrixData, pch = 19, diag.panel=panel.hist)
```


```{r}
m_ageC <- lm(log(Testosterone)~
                 AgeQ2 + AgeQ3 + AgeQ4 + 
                 Sex + Race1 + PhysAc + Depress + Weight + Height +
                 Diabete + HypT + TotChol + RegularMarij2, 
             data = nh2)
summary(m_ageC)
```
```{r}
checka <- function (model) {
  car::avPlots(model)
  plot(model$fitted.values, model$residuals)
  hist(model$residuals)
  qqnorm(model$residuals)
  shapiro.test(model$residuals)
}
checka(m_ageC)
```

```{r}
## Check age linearity
plot(1:3, m_ageC$coefficients[2:4])
```

double check the quadratic

```{r}
Agec <- (nh2$Age-mean(nh2$Age))/sd(nh2$Age)
m_age_it_2 <- lm(log(Testosterone) ~ 
                    I(Agec) + I(Agec^2)+
                    Sex + Race1 + PhysAc + Depress + Diabete + 
                    HypT+ TotChol + RegularMarij2 +  Weight + Height, 
                data = nh2)
summary(m_age_it_2)
```


```{r}
## Complete case model nh2
nh2 <- nh1 %>% drop_na() #drop anything with NA
## Full model with age as continuous variable

m1 =  lm(log(Testosterone)~
             Agec + Sex + Race1 + PhysAc + Depress + Weight + 
             Diabete + HypT + TotChol + RegularMarij2 + Height, 
         data = nh2)
summary(m1)
```


```{r}
# Model with Race as well coding, want to see if can combine race categories
m_wo_its =  lm(log(Testosterone)~
             -1 + Agec + Sex + Race1 + PhysAc + Depress + Weight + 
             Diabete + HypT + TotChol + RegularMarij2 + Height, 
         data = nh2)
summary(m_wo_its)
```

```{r}
#Test to see (4) racial categories can be combined into one
Contrast.T = matrix(c(0,0,1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0,0,0,0,0,0),byrow = T, nrow = 4) 

car::linearHypothesis(model=m_wo_its,hypothesis.matrix=Contrast.T, rsh=c(0,0,0,0))
```
```{r}
Contrast.T = matrix(c(0,0,0,1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,-1,0,0,0,0,0,0,0,0),byrow = T, nrow = 3)

car::linearHypothesis(model=m_wo_its,hypothesis.matrix=Contrast.T, rsh=c(0,0,0))
```


```{r}
#Recode race into black and non-black
nh2 <- nh2 %>%
  mutate(Race2 = ifelse(nh2$Race1 == "Black", 0, 1))
#model with intercept and race as binary
m1.2 =  lm(log(Testosterone)~
             Agec + Sex + Race2 + PhysAc + Depress + Weight + 
             Diabete + HypT + TotChol + RegularMarij2 + Height, 
         data = nh2)
summary(m1.2)
car::avPlots(m1.2)
plot(m1.2$fitted.values, m1.2$residuals)
```

According to the plot we found out that age, weight, height, and BPSysAve are linear. We can use age as a non-categorical value because it gives us higher r^2
```{r}
checka(m1.2)
```



```{r}
## model without interaction
m_age_woit <- lm(log(Testosterone) ~ 
                    Agec + 
                    Sex + Race2 + PhysAc + Depress + Diabete + 
                    HypT+ TotChol + RegularMarij2 +  Weight + Height, 
                data = nh2)
summary(m_age_woit)
```

```{r}
## full model with interaction : Final model based on journal reading
m_age_it <- lm(log(Testosterone) ~ 
                    Age + 
                    Sex + Race2 + PhysAc + Diabete + TotChol +
                    HypT + RegularMarij2 +  Weight + Height +
                    HypT*Weight + Weight*Height + Age*(Weight + Height) +
                    Diabete*(Weight + PhysAc + TotChol) + RegularMarij2*PhysAc
               ,
                data = nh2)
summary(m_age_it)
```

```{r}
## Check co-linearity
cor(nh2[c("Age","Diabete", "TotChol", "HypT", "PhysAc","Depress", "Weight", "Height")])

## Add VIF later
```

```{r}
olsrr::ols_step_backward_p(m_age_it, prem = 0.25, details=F)
```

```{r}
## Final model
m_age_it <- lm(log(Testosterone) ~ 
                    Agec + 
                    Sex + Race2 + Diabete + 
                    HypT + RegularMarij2 +  Weight + Height + 
                    Weight*Height + Agec*(Weight + Height) +
                    Diabete*PhysAc + RegularMarij2*PhysAc
               ,
                data = nh2)
summary(m_age_it)
```


## linearity check
```{r}
checka(m_age_it)
```
```{r}
## For independence, we check literature. 
```

## Improve model by identifing outliers



